# ゲーム翻訳オーバーレイアプリケーション - アーキテクチャ概要

## 1. アーキテクチャの全体像

ゲーム翻訳オーバーレイアプリケーションは、レイヤード設計パターンを採用し、責務を明確に分離したモジュラーなアーキテクチャを実現しています。この設計により、拡張性、保守性、そして堅牢性を確保しています。

### 1.1 全体アーキテクチャ図

```
+---------------------+     +-------------------+     +---------------------+
|                     |     |                   |     |                     |
|    UIレイヤー       | --> |   コアレイヤー    | --> |   外部サービス      |
|   (Forms)           |     |   (Core)          |     |   連携レイヤー      |
|                     |     |                   |     |                     |
+---------------------+     +-------------------+     +---------------------+
         |                          |                           |
         |                          |                           |
         v                          v                           v
+---------------------+     +-------------------+     +---------------------+
|                     |     |                   |     |                     |
|   コンフィグレーション| <-- |   診断・ログ     | <-- |   データストレージ   |
|   (Configuration)   |     |   (Diagnostics)   |     |   (Storage)         |
|                     |     |                   |     |                     |
+---------------------+     +-------------------+     +---------------------+
```

## 2. レイヤー構造

### 2.1 UIレイヤー (Forms)

ユーザーインターフェースを提供するレイヤーです。Windows Forms（.NET Framework 4.8）を使用し、ユーザー入力の処理、視覚的フィードバック、設定画面を担当します。

**主要コンポーネント**:
- **MainForm**: アプリケーションのメインウィンドウ
- **OverlayForm**: ゲーム画面上に表示される透明なオーバーレイ
- **TranslationBox**: 翻訳結果を表示するコンポーネント
- **SettingsForm**: アプリケーション設定を管理する画面

**設計上の特徴**:
- クリックスルー機能を持つ透過UIにより、ゲーム操作を妨げない
- 最小限の存在感を持つデザインで、ユーザー没入体験を重視
- 直感的なボタンUIによる簡単な操作性

### 2.2 コアレイヤー (Core)

アプリケーションの中核機能を提供するレイヤーです。以下のサブシステムで構成されています。

#### 2.2.1 OCR (光学文字認識)

ゲーム画面からのテキスト認識を担当します。

**主要コンポーネント**:
- **OcrManager**: OCR処理の統合管理
- **PaddleOcrEngine**: PaddleOCRを使用したテキスト認識
- **TextDetectionService**: テキスト検出サービス
- **DifferenceDetector**: 画面変更検出による最適化

**設計上の特徴**:
- 差分検出によるパフォーマンス最適化
- AI支援による自動OCR設定最適化
- 様々なゲームフォントに対応する柔軟性

#### 2.2.2 Translation (翻訳処理)

検出されたテキストの翻訳を担当します。

**主要コンポーネント**:
- **TranslationManager**: 翻訳処理の一元管理
- **LibreTranslateEngine**: ローカル翻訳エンジン
- **AITranslationEngine**: AI翻訳エンジン（OpenAI/Google Gemini）
- **TranslationCache**: 翻訳結果のキャッシュ
- **LanguageDetector**: 言語自動検出機能

**設計上の特徴**:
- プラグイン可能な翻訳エンジン設計（インターフェースベース）
- 多言語対応のための言語自動検出
- キャッシュによるパフォーマンス最適化
- オンライン/オフラインのハイブリッド動作

#### 2.2.3 Region (画面領域管理)

ゲーム画面の選択と管理を担当します。

**主要コンポーネント**:
- **RegionManager**: 選択領域の管理
- **ScreenCapture**: 画面キャプチャ機能

#### 2.2.4 Security (セキュリティ)

APIキーの暗号化と管理を担当します。

**主要コンポーネント**:
- **ApiKeyProtector**: APIキーの暗号化と管理
- **EncryptionHelper**: 汎用暗号化機能

### 2.3 外部サービス連携レイヤー

外部サービスとの通信を担当するレイヤーです。

**主要コンポーネント**:
- **VisionServiceClient**: AIビジョンサービス（OpenAI, Google Gemini）との連携
- **HttpClientWrapper**: HTTP通信の抽象化

### 2.4 診断・ログレイヤー (Diagnostics)

アプリケーションの状態監視、エラー処理、パフォーマンス測定を担当します。

**主要コンポーネント**:
- **Logger**: ログ記録機能
- **ErrorReporter**: エラー報告機能
- **DiagnosticsCollector**: 診断情報収集

### 2.5 コンフィグレーションレイヤー (Configuration)

アプリケーション設定の管理を担当します。

**主要コンポーネント**:
- **AppSettings**: アプリケーション設定の管理
- **GameProfiles**: ゲームごとの設定プロファイル
- **LicenseManager**: ライセンス状態の管理

## 3. 主要データフロー

### 3.1 テキスト認識から翻訳表示までのフロー

1. **スクリーンキャプチャ**
   - ゲームウィンドウの画面をキャプチャ
   - 差分検出による変更確認

2. **OCR処理**
   - テキスト領域の検出
   - テキスト認識
   - 結果の構造化

3. **言語検出**
   - 認識テキストの言語特性分析
   - 適切な翻訳方向の決定

4. **翻訳処理**
   - キャッシュの確認
   - 必要に応じて翻訳APIの呼び出し
   - 翻訳結果の保存

5. **UI表示**
   - 翻訳結果のフォーマット
   - オーバーレイへの表示
   - UI更新

## 4. 採用しているアーキテクチャパターン

### 4.1 レイヤードアーキテクチャ
UI層、ビジネスロジック層、データアクセス層の明確な分離により、各層の独立した開発と保守を可能にしています。

### 4.2 依存性逆転の原則
上位モジュールが下位モジュールに依存せず、両者が抽象（インターフェース）に依存する設計を採用しています。これにより、コンポーネントの交換可能性と拡張性を確保しています。

### 4.3 シングルトンパターン
アプリケーション全体で共有されるべきリソース（設定、ロガーなど）に対してシングルトンパターンを適用し、一貫した状態管理を実現しています。

### 4.4 ストラテジーパターン
翻訳エンジンやOCRエンジンの実装を交換可能にするため、ストラテジーパターンを採用しています。これにより、新しいエンジンの追加が容易になっています。

### 4.5 オブザーバーパターン
UIコンポーネント間の通知や、テキスト検出イベントの伝播にオブザーバーパターン（C#ではイベント）を使用しています。

## 5. 基本方針のアーキテクチャ反映

### 5.1 ユーザー没入体験の重視
- 透過オーバーレイUI設計によるゲーム体験への最小限の干渉
- AI自動最適化による手動設定の最小化
- 直感的なボタンUIによる簡単な操作性

### 5.2 幅広い対象アプリケーション
- 特定のゲームエンジンやUIフレームワークに依存しない汎用的なスクリーンキャプチャ
- ゲームプロファイル機能による様々なアプリケーションへの対応
- 多様なフォントや画面レイアウトに対応するOCR前処理

### 5.3 多言語対応
- 言語検出による自動翻訳方向の決定
- 複数の翻訳エンジンをプラグイン可能な設計
- 多言語フォントサポート

## 6. 実際のプロジェクト構造との対応

現在のプロジェクト構造は以下のように論理的なアーキテクチャと対応しています：

```
app/
├── Core/                      # コアレイヤー
│   ├── Configuration/        # 設定管理
│   ├── Diagnostics/          # 診断・ログ機能
│   ├── Licensing/            # ライセンス管理
│   ├── Models/               # 共通データモデル
│   ├── OCR/                  # OCR機能
│   │   ├── AI/              # AI最適化機能
│   │   ├── Benchmark/       # OCRベンチマーク
│   │   └── Utils/           # OCRユーティリティ
│   ├── Region/               # 画面領域管理
│   ├── Security/             # セキュリティ機能
│   ├── TextDetection/        # テキスト検出機能
│   ├── Translation/          # 翻訳機能
│   ├── UI/                   # UI関連コア機能
│   ├── Utils/                # 共通ユーティリティ
│   └── WindowManagement/     # ウィンドウ管理
├── Forms/                     # UIレイヤー
│   └── Settings/             # 設定画面
└── Properties/                # プロジェクトプロパティ
```

## 7. 関連ドキュメント

- [プロジェクト概要](../01-overview/project-overview.md) - プロジェクトの目的と概要
- [要件定義書](../01-overview/requirements.md) - 機能要件と非機能要件の詳細
- [システムアーキテクチャ詳細](../02-design/system-architecture.md) - アーキテクチャの詳細設計
- [OCR機能設計](../02-design/components/ocr-component.md) - OCRコンポーネントの詳細設計
- [翻訳機能設計](../02-design/components/translation-component.md) - 翻訳コンポーネントの詳細設計
- [UI設計仕様](../02-design/components/ui-component.md) - UIコンポーネントの設計
- [データフロー設計](../02-design/data-flow.md) - 主要データフローの詳細
